version: '3.8'

# =============================================================================
# AIVIUE PLATFORM - DOCKER COMPOSE
# =============================================================================
# 
# Services:
#   - api: FastAPI backend (port 8000)
#   - worker: Background extraction worker
#   - redis: Cache, queue, events (port 6379)
#
# Note: PostgreSQL is hosted on Supabase, not included here.
#
# Usage:
#   # Development (all services)
#   docker-compose up -d
#
#   # View logs
#   docker-compose logs -f api
#
#   # Run migrations
#   docker-compose exec api alembic upgrade head
#
#   # Stop all
#   docker-compose down
# =============================================================================

services:
  # ===================== API SERVICE =====================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: aiviue-api
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=development
      - DEBUG=true
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CORS_ORIGINS=http://localhost:3000,http://localhost:5173
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      # Mount source for hot reload in development
      - ../app:/app/app:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - aiviue-network

  # ===================== WORKER SERVICE =====================
  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.worker
    container_name: aiviue-worker
    environment:
      - APP_ENV=development
      - DEBUG=true
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ../app:/app/app:ro
    restart: unless-stopped
    networks:
      - aiviue-network

  # ===================== REDIS =====================
  redis:
    image: redis:7-alpine
    container_name: aiviue-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - aiviue-network

# ===================== NETWORKS =====================
networks:
  aiviue-network:
    driver: bridge

# ===================== VOLUMES =====================
volumes:
  redis-data:
    driver: local
